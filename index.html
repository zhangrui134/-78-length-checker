<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>78é•¿åº¦æŸ¥è¯¢å™¨</title>
    <meta name="description" content="æµ‹è¯•ä½ çš„78é•¿åº¦ï¼ŒæŸ¥çœ‹å®æ—¶æ’è¡Œæ¦œï¼Œå’Œæœ‹å‹ä¸€èµ·ç©ï¼">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
            text-align: center;
        }
        .security-notice {
            background: #e8f6f3;
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        .security-text {
            color: #27ae60;
            font-weight: bold;
        }
        .name-examples {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
        }
        .input-hint {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }
        .name-available {
            color: #27ae60;
            font-size: 12px;
            margin-top: 4px;
            font-weight: bold;
        }
        .name-taken {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 4px;
            font-weight: bold;
        }
        .name-checking {
            color: #f39c12;
            font-size: 12px;
            margin-top: 4px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 10px;
            -webkit-appearance: none;
            transition: all 0.3s ease;
        }
        input:focus {
            outline: none;
            border-color: #3498db;
        }
        button {
            width: 100%;
            padding: 16px;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            margin-bottom: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .query-btn {
            background: #e74c3c;
        }
        .ranking-btn {
            background: #3498db;
        }
        .refresh-btn {
            background: #27ae60;
        }
        .share-btn {
            background: #9b59b6;
        }
        .admin-btn {
            background: #e67e22;
        }
        .result-box {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            text-align: center;
        }
        .length-result {
            font-size: 48px;
            font-weight: bold;
            color: #e74c3c;
            margin: 10px 0;
        }
        .unit {
            font-size: 18px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        .size-tip {
            font-size: 16px;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .tip-small {
            background: #e8f6f3;
            color: #27ae60;
            border: 2px solid #27ae60;
        }
        .tip-medium {
            background: #fff3cd;
            color: #f39c12;
            border: 2px solid #f39c12;
        }
        .tip-large {
            background: #fde8e8;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }
        .tip-error {
            background: #ffeaa7;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }
        .ranking-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }
        .ranking-horizontal {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .rank-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .rank-card:active {
            transform: scale(0.95);
        }
        .rank-1 {
            border-color: #FFD700;
            background: linear-gradient(135deg, #FFD700, #FFEC8B);
        }
        .rank-2 {
            border-color: #C0C0C0;
            background: linear-gradient(135deg, #C0C0C0, #E8E8E8);
        }
        .rank-3 {
            border-color: #CD7F32;
            background: linear-gradient(135deg, #CD7F32, #E8B886);
            color: white;
        }
        .rank-medal {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .rank-number {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .player-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-all;
        }
        .player-score {
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
        }
        .player-id {
            font-size: 10px;
            color: #95a5a6;
            margin-top: 3px;
        }
        .stats {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: #e8f6f3;
            border-radius: 8px;
            font-size: 16px;
        }
        .back-to-top {
            text-align: center;
            margin-top: 20px;
        }
        .back-to-top a {
            color: #3498db;
            text-decoration: none;
            font-size: 16px;
            padding: 10px 20px;
            display: inline-block;
        }
        .share-section {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }
        .rank-card:hover .delete-btn {
            display: block;
        }

        /* ç®¡ç†å‘˜æ‚¬æµ®çƒæ ·å¼ */
        .admin-float-ball {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #e67e22, #d35400);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s ease;
            user-select: none;
        }
        .admin-float-ball:hover {
            transform: scale(1.1);
        }
        .admin-float-ball.active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        .admin-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 200px;
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            z-index: 999;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .admin-panel.active {
            display: block;
        }
        .admin-panel h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
        }
        .admin-panel input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .admin-panel button {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        .admin-panel .delete-all-btn {
            background: #e74c3c;
            color: white;
        }
        .admin-panel .toggle-delete-btn {
            background: #3498db;
            color: white;
        }
        .admin-panel .close-btn {
            background: #95a5a6;
            color: white;
        }
        .admin-status {
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
            padding: 5px;
            border-radius: 5px;
        }
        .admin-status.active {
            background: #e8f6f3;
            color: #27ae60;
        }
        .admin-status.inactive {
            background: #fde8e8;
            color: #e74c3c;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 24px;
            }
            .length-result {
                font-size: 42px;
            }
            .rank-card {
                min-width: 110px;
                padding: 12px;
            }
            .admin-float-ball {
                width: 50px;
                height: 50px;
                font-size: 20px;
                bottom: 15px;
                right: 15px;
            }
            .admin-panel {
                width: 180px;
                bottom: 75px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- ç®¡ç†å‘˜æ‚¬æµ®çƒ -->
    <div class="admin-float-ball" id="adminFloatBall">
        âš™ï¸
    </div>
    
    <!-- ç®¡ç†å‘˜é¢æ¿ -->
    <div class="admin-panel" id="adminPanel">
        <h3>ç®¡ç†å‘˜åŠŸèƒ½</h3>
        <input type="password" id="adminPassword" placeholder="è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
        <button class="toggle-delete-btn" onclick="toggleAdminMode()">è¿›å…¥ç®¡ç†æ¨¡å¼</button>
        <button class="delete-all-btn" onclick="deleteAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        <button class="close-btn" onclick="closeAdminPanel()">å…³é—­é¢æ¿</button>
        <div class="admin-status inactive" id="adminStatus">æœªç™»å½•</div>
    </div>

    <div class="container">
        <h1>78é•¿åº¦æŸ¥è¯¢å™¨</h1>
        <div class="subtitle">æµ‹è¯•ä½ çš„78é•¿åº¦å¹¶æŸ¥çœ‹æ’è¡Œæ¦œ</div>
        
        <div class="security-notice">
            <div class="security-text">âœ… å·²åŠ å¼ºå®‰å…¨é˜²æŠ¤ - é˜²æ­¢æ¶æ„è¾“å…¥</div>
            <div class="name-examples">è¯·ä½¿ç”¨çœŸå®å§“åæˆ–å¸¸ç”¨æ˜µç§°ï¼Œç¦æ­¢æ¶æ„æ£ä¹±</div>
        </div>
        
        <div class="input-group">
            <label>ç”¨æˆ·åï¼š</label>
            <input type="text" id="username" 
                   placeholder="è¯·è¾“å…¥çœŸå®å§“åæˆ–å¸¸ç”¨æ˜µç§°" 
                   maxlength="10"
                   required
                   oninput="validateNameInput(this)">
            <div class="input-hint">åªèƒ½è¾“å…¥ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ï¼Œ2-10ä¸ªå­—ç¬¦</div>
            <div id="nameStatus"></div>
        </div>
        
        <div class="input-group">
            <label>èº«é«˜ï¼ˆcmï¼‰ï¼š</label>
            <input type="number" id="height" placeholder="è¯·è¾“å…¥èº«é«˜(100-250cm)" min="100" max="250" pattern="[0-9]*" inputmode="numeric" required>
            <div class="input-hint">è¯·è¾“å…¥100-250ä¹‹é—´çš„æ•°å­—</div>
        </div>
        
        <button class="query-btn" onclick="calculateAndSave()">
            ğŸ“ å¼€å§‹æŸ¥è¯¢å¹¶ä¿å­˜
        </button>
        
        <button class="ranking-btn" onclick="scrollToRanking()">
            ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ
        </button>
        
        <div class="result-box">
            <h3>æŸ¥è¯¢ç»“æœ</h3>
            <div class="length-result" id="lengthDisplay">0.00</div>
            <div class="unit">å˜ç±³</div>
            <div id="sizeTip" class="size-tip"></div>
            <div id="rankInfo" style="margin-top: 10px;"></div>
        </div>

        <div class="share-section">
            <h4>åˆ†äº«ç»™æœ‹å‹</h4>
            <button class="share-btn" onclick="shareApp()">
                ğŸ“± åˆ†äº«é“¾æ¥
            </button>
        </div>

        <div class="ranking-section" id="rankingSection">
            <h2 style="text-align:center; color:#2c3e50; margin-bottom:20px;">ğŸ† å¥½å‹æ’è¡Œæ¦œ</h2>
            
            <button class="refresh-btn" onclick="loadRanking()">
                ğŸ”„ åˆ·æ–°æ’è¡Œæ¦œ
            </button>
            
            <div class="stats" id="stats">
                åŠ è½½ä¸­...
            </div>
            
            <div class="ranking-horizontal" id="rankingList">
                æ­£åœ¨åŠ è½½æ’è¡Œæ¦œæ•°æ®...
            </div>
            
            <div class="back-to-top">
                <a href="#" onclick="scrollToTop()">â†‘ è¿”å›é¡¶éƒ¨</a>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ryecnwmicmondyefflgb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5ZWNud21pY21vbmR5ZWZmbGdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDUxMDQsImV4cCI6MjA3ODc4MTEwNH0.xzspaXXU3ee-mWuoUA2VPA2k2n6oyXldU-B651fK5sc';
        
        let usernameCheckTimeout;
        let lastSubmitTime = 0;
        let isAdminMode = false;
        const ADMIN_PASSWORD = "850611@QQ.com";

        // ç”¨æˆ·æäº¤è®°å½• - é˜²åˆ·æ¦œ
        const userSubmissionCache = new Map();

        function generateUserId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        function validateRealName(name) {
            if (name.length < 2) return { valid: false, message: 'ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦' };
            
            const basicRegex = /^[\u4e00-\u9fa5a-zA-Z0-9]{2,10}$/;
            if (!basicRegex.test(name)) return { valid: false, message: 'åªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—' };
            
            const repeatRegex = /(.)\1{2,}/;
            if (repeatRegex.test(name)) return { valid: false, message: 'ä¸èƒ½åŒ…å«é‡å¤å­—ç¬¦' };
            
            const onlyNumbers = /^\d+$/;
            if (onlyNumbers.test(name)) return { valid: false, message: 'ä¸èƒ½æ˜¯çº¯æ•°å­—' };
            
            const hasLetter = /[\u4e00-\u9fa5a-zA-Z]/;
            if (!hasLetter.test(name)) return { valid: false, message: 'å¿…é¡»åŒ…å«ä¸­æ–‡æˆ–è‹±æ–‡å­—æ¯' };
            
            const badWords = ['admin','test','aaa','111','123','abc','xxx','qqq','www','asd','qwe','zxc','123456','000','666','888','999','test1','test2','user','user1','aaa123','abc123','ä¸€äºŒä¸‰','æµ‹è¯•','è¯•éªŒ','å®éªŒ','æ£ä¹±','ç ´å','åƒåœ¾','åºŸç‰©','å‚»å­','ç¬¨è›‹','sb','fuck','shit','bitch','asshole','idiot','stupid'];
            const lowerName = name.toLowerCase();
            if (badWords.some(word => lowerName === word || lowerName.includes(word))) {
                return { valid: false, message: 'è¯·ä½¿ç”¨çœŸå®å§“åæˆ–å¸¸ç”¨æ˜µç§°' };
            }
            
            return { valid: true, message: '' };
        }

        // æ£€æŸ¥ç”¨æˆ·å½“æ—¥æäº¤æ¬¡æ•°
        function checkUserDailyLimit(username) {
            const today = new Date().toDateString();
            const userKey = `${username}_${today}`;
            
            const userData = userSubmissionCache.get(userKey) || { count: 0, date: today };
            
            // æ¸…ç†è¿‡æœŸçš„è®°å½•
            if (userData.date !== today) {
                userData.count = 0;
                userData.date = today;
            }
            
            if (userData.count >= 3) {
                return false;
            }
            
            userData.count++;
            userSubmissionCache.set(userKey, userData);
            
            // æ¸…ç†ç¼“å­˜ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
            if (userSubmissionCache.size > 1000) {
                const keys = Array.from(userSubmissionCache.keys());
                keys.slice(0, 500).forEach(key => userSubmissionCache.delete(key));
            }
            
            return true;
        }

        // æ£€æµ‹é‡å¤æ•°æ®
        async function detectDuplicateData(username, score) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/game_scores?player_name=eq.${encodeURIComponent(username)}&score=eq.${score}&select=id`, {
                    headers: { 'apikey': SUPABASE_KEY }
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.length > 0;
                }
            } catch (error) {
                console.error('æ£€æµ‹é‡å¤æ•°æ®å¤±è´¥:', error);
            }
            return false;
        }

        // ç”¨æˆ·çº§é¢‘ç‡æ§åˆ¶
        const userCooldown = new Map();
        function checkUserCooldown(username) {
            const now = Date.now();
            const lastTime = userCooldown.get(username) || 0;
            
            if (now - lastTime < 60000) {
                const remaining = Math.ceil((60000 - (now - lastTime)) / 1000);
                alert(`æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·${remaining}ç§’åå†è¯•`);
                return false;
            }
            
            userCooldown.set(username, now);
            return true;
        }

        function validateNameInput(input) {
            const name = input.value.trim();
            const nameStatus = document.getElementById('nameStatus');
            
            clearTimeout(usernameCheckTimeout);
            input.value = input.value.replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '');
            
            if (name.length === 0) {
                nameStatus.innerHTML = '';
                input.style.borderColor = '#e9ecef';
                input.style.backgroundColor = 'white';
                return;
            }
            
            const validation = validateRealName(name);
            if (!validation.valid) {
                nameStatus.innerHTML = `<div class="name-taken">${validation.message}</div>`;
                input.style.borderColor = '#e74c3c';
                input.style.backgroundColor = '#fde8e8';
                return;
            }
            
            nameStatus.innerHTML = '<div class="name-available">âœ… ç”¨æˆ·åå¯ç”¨</div>';
            input.style.borderColor = '#27ae60';
            input.style.backgroundColor = '#e8f6f3';
        }

        function shareApp() {
            const url = window.location.href;
            const title = '78é•¿åº¦æŸ¥è¯¢å™¨ - å¿«æ¥æµ‹è¯•ä½ çš„78é•¿åº¦ï¼';
            
            if (navigator.share) {
                navigator.share({ title: title, url: url });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('é“¾æ¥å·²å¤åˆ¶ï¼\n\nåˆ†äº«ç»™æœ‹å‹ï¼š' + url);
                });
            }
        }
        
        function scrollToRanking() {
            document.getElementById('rankingSection').scrollIntoView({ behavior: 'smooth' });
            loadRanking();
        }
        
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function calculateLength(height) {
            let result = ((height - 105) * 0.618 / 3.14);
            if (result < 0) return null;
            return result.toFixed(2);
        }

        function getSizeTip(length) {
            if (length === null) return { text: 'âŒ è®¡ç®—é”™è¯¯ï¼šè¯·è¾“å…¥åˆç†çš„èº«é«˜(105cmä»¥ä¸Š)', class: 'tip-error' };
            
            const numLength = parseFloat(length);
            if (numLength < 5) return { text: 'ğŸ’ è¿·ä½ å°ºå¯¸ï¼Œè¶…çº§å¯çˆ±ï¼', class: 'tip-small' };
            else if (numLength < 10) return { text: 'âœ¨ å°å·§ç²¾è‡´ï¼Œç‹¬å…·é­…åŠ›ï¼', class: 'tip-small' };
            else if (numLength < 15) return { text: 'â­ æ ‡å‡†å°ºå¯¸ï¼Œæ°åˆ°å¥½å¤„ï¼', class: 'tip-medium' };
            else if (numLength < 20) return { text: 'ğŸ”¥ é›„ä¼Ÿå£®è§‚ï¼Œæ°”åŠ¿éå‡¡ï¼', class: 'tip-medium' };
            else if (numLength < 50) return { text: 'ğŸš€ è¶…çº§å°ºå¯¸ï¼Œéœ‡æ’¼å…¨åœºï¼', class: 'tip-large' };
            else return { text: 'âš ï¸ è­¦å‘Šï¼æ£€æµ‹åˆ°è¶…å‡ºäººç±»ç†è§£èŒƒå›´çš„è¶…çº§é•¿åº¦ï¼', class: 'tip-large' };
        }

        async function calculateAndSave() {
            const now = Date.now();
            if (now - lastSubmitTime < 3000) {
                alert('æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•');
                return;
            }
            lastSubmitTime = now;

            const username = document.getElementById('username').value.trim();
            const height = parseFloat(document.getElementById('height').value);
            
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            const validation = validateRealName(username);
            if (!validation.valid) {
                alert('ç”¨æˆ·åéªŒè¯å¤±è´¥ï¼š\n' + validation.message + '\n\nè¯·ä½¿ç”¨çœŸå®å§“åæˆ–å¸¸ç”¨æ˜µç§°');
                return;
            }
            
            if (!height || height < 100 || height > 250) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„èº«é«˜ï¼ˆ100-250cmï¼‰');
                return;
            }
            
            // === æ–°å¢é˜²æŠ¤æ£€æµ‹ ===
            if (!checkUserDailyLimit(username)) {
                alert('æ¯ä¸ªç”¨æˆ·æ¯å¤©æœ€å¤šæäº¤3æ¬¡ï¼');
                return;
            }
            
            if (!checkUserCooldown(username)) {
                return;
            }
            
            const queryBtn = document.querySelector('.query-btn');
            const originalText = queryBtn.textContent;
            queryBtn.textContent = 'æäº¤ä¸­...';
            queryBtn.disabled = true;
            
            try {
                const length = calculateLength(height);
                if (length === null) {
                    alert('âŒ è®¡ç®—é”™è¯¯ï¼šè¯·è¾“å…¥105cmä»¥ä¸Šçš„èº«é«˜');
                    return;
                }
                
                // æ£€æµ‹é‡å¤æ•°æ®
                if (await detectDuplicateData(username, parseFloat(length))) {
                    alert('è¯·å‹¿é‡å¤æäº¤ç›¸åŒæ•°æ®ï¼');
                    return;
                }
                
                document.getElementById('lengthDisplay').textContent = length;
                const sizeTip = getSizeTip(length);
                const sizeTipElement = document.getElementById('sizeTip');
                sizeTipElement.textContent = sizeTip.text;
                sizeTipElement.className = 'size-tip ' + sizeTip.class;
                
                const userId = generateUserId();
                
                const response = await fetch(SUPABASE_URL + '/rest/v1/game_scores', {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player_name: username,
                        score: parseFloat(length),
                        user_id: userId
                    })
                });
                
                if (response.ok) {
                    const rankingData = await getRankingData();
                    const userRank = rankingData.findIndex(item => item.user_id === userId) + 1;
                    const totalPlayers = rankingData.length;
                    const percentage = totalPlayers > 0 ? Math.round(((totalPlayers - userRank) / totalPlayers) * 1000) / 10 : 0;
                    
                    document.getElementById('rankInfo').innerHTML = `
                        <div style="background:#e8f6f3; padding:10px; border-radius:8px;">
                            <strong>ç¬¬${userRank}å</strong><br>
                            è¶…è¶Šäº†${percentage}%çš„å¥½å‹
                        </div>
                    `;
                    
                    alert(`ğŸ‰ ä¿å­˜æˆåŠŸï¼\n${username}ï¼š${length}cm\næ’åï¼šç¬¬${userRank}å`);
                    scrollToRanking();
                } else {
                    const error = await response.text();
                    if (error.includes('duplicate key')) {
                        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                    } else if (error.includes('check constraint')) {
                        alert('ç”¨æˆ·åä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ä½¿ç”¨çœŸå®å§“åæˆ–å¸¸ç”¨æ˜µç§°');
                    } else {
                        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            } finally {
                queryBtn.textContent = originalText;
                queryBtn.disabled = false;
            }
        }

        async function getRankingData() {
            try {
                const response = await fetch(SUPABASE_URL + '/rest/v1/game_scores?select=player_name,score,id,user_id&order=score.desc', {
                    headers: { 'apikey': SUPABASE_KEY }
                });
                if (response.ok) return await response.json();
            } catch (error) {
                console.error('è·å–æ’è¡Œæ¦œæ•°æ®å¤±è´¥:', error);
            }
            return [];
        }

        function showPlayerDetail(playerName, score, rank, userId) {
            alert(`ğŸ‘¤ ${playerName}\nğŸ† ç¬¬${rank}å\nğŸ“ ${score}cm\nğŸ†” ${userId}`);
        }

        async function deletePlayerRecord(id, playerName) {
            if (!isAdminMode) {
                alert('è¯·å…ˆè¿›å…¥ç®¡ç†å‘˜æ¨¡å¼');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${playerName} çš„è®°å½•å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(SUPABASE_URL + '/rest/v1/game_scores?id=eq.' + id, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY
                    }
                });
                
                if (response.ok) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadRanking();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        async function loadRanking() {
            const rankingList = document.getElementById('rankingList');
            const stats = document.getElementById('stats');
            
            rankingList.innerHTML = 'æ­£åœ¨åŠ è½½...';
            stats.innerHTML = 'åŠ è½½ä¸­...';
            
            try {
                const data = await getRankingData();
                stats.innerHTML = `å…± ${data.length} äººå‚ä¸ â€¢ æœ€é«˜è®°å½•: ${data.length > 0 ? data[0].score + 'cm' : 'æš‚æ— '}`;
                
                if (data.length > 0) {
                    let html = '';
                    data.forEach((item, index) => {
                        const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
                        const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                        html += `
                            <div class="rank-card ${rankClass}" onclick="showPlayerDetail('${item.player_name}', ${item.score}, ${index + 1}, '${item.user_id}')">
                                ${isAdminMode ? `<button class="delete-btn" onclick="event.stopPropagation(); deletePlayerRecord('${item.id}', '${item.player_name}')">Ã—</button>` : ''}
                                <div class="rank-medal">${medal}</div>
                                <div class="rank-number">ç¬¬${index + 1}å</div>
                                <div class="player-name">${item.player_name}</div>
                                <div class="player-score">${item.score}cm</div>
                                <div class="player-id">ID: ${item.user_id.substring(0, 8)}</div>
                            </div>`;
                    });
                    rankingList.innerHTML = html;
                } else {
                    rankingList.innerHTML = '<div style="text-align:center; padding:20px; color:#7f8c8d;">æš‚æ— æ•°æ®ï¼Œå¿«æ¥å½“ç¬¬ä¸€ä¸ªï¼</div>';
                }
            } catch (error) {
                rankingList.innerHTML = '<div style="text-align:center; padding:20px; color:#e74c3c;">ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥</div>';
                stats.innerHTML = 'ç½‘ç»œé”™è¯¯';
            }
        }

        // ç®¡ç†å‘˜é¢æ¿åŠŸèƒ½
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            const ball = document.getElementById('adminFloatBall');
            
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                ball.classList.remove('active');
            } else {
                panel.classList.add('active');
                ball.classList.add('active');
            }
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.remove('active');
            document.getElementById('adminFloatBall').classList.remove('active');
        }

        function toggleAdminMode() {
            const password = document.getElementById('adminPassword').value;
            const status = document.getElementById('adminStatus');
            
            if (!isAdminMode) {
                if (password === ADMIN_PASSWORD) {
                    isAdminMode = true;
                    status.textContent = 'å·²ç™»å½• - å•ä¸ªåˆ é™¤æ¨¡å¼å·²å¼€å¯';
                    status.className = 'admin-status active';
                    document.getElementById('adminPassword').value = '';
                    alert('å·²è¿›å…¥ç®¡ç†å‘˜æ¨¡å¼ï¼Œç°åœ¨å¯ä»¥åˆ é™¤å•ä¸ªè®°å½•äº†');
                    loadRanking();
                } else {
                    alert('å¯†ç é”™è¯¯');
                }
            } else {
                isAdminMode = false;
                status.textContent = 'æœªç™»å½•';
                status.className = 'admin-status inactive';
                alert('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
                loadRanking();
            }
        }

        async function deleteAllData() {
            if (!isAdminMode) {
                alert('è¯·å…ˆè¿›å…¥ç®¡ç†å‘˜æ¨¡å¼');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            try {
                const response = await fetch(SUPABASE_URL + '/rest/v1/game_scores', {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY
                    }
                });
                
                if (response.ok) {
                    alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
                    loadRanking();
                } else {
                    alert('æ¸…ç©ºæ•°æ®å¤±è´¥');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        window.onload = function() {
            loadRanking();
            
            document.getElementById('adminFloatBall').addEventListener('click', toggleAdminPanel);
            
            document.addEventListener('click', function(event) {
                const panel = document.getElementById('adminPanel');
                const ball = document.getElementById('adminFloatBall');
                
                if (panel.classList.contains('active') && 
                    !panel.contains(event.target) && 
                    !ball.contains(event.target)) {
                    closeAdminPanel();
                }
            });
        };

        setInterval(loadRanking, 30000);

        document.getElementById('height').addEventListener('input', function() {
            const height = parseFloat(this.value);
            if (height && height < 105) {
                this.style.borderColor = '#e74c3c';
                this.style.backgroundColor = '#fde8e8';
            } else {
                this.style.borderColor = this.value ? '#27ae60' : '#e9ecef';
                this.style.backgroundColor = 'white';
            }
        });
        
        document.addEventListener('touchstart', function() {}, {passive: true});
    </script>
</body>
</html>
